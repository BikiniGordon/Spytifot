{% extends "base.html" %}
{% block title %}Playlist - Music Playlist{% endblock %}

{% block content %}
  <div class="container-card">
    <h2>Playlist Manager</h2>
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
      <div>
        <label style="font-weight:700;margin-right:6px">Current Playlist:</label>
        <select id="playlistSelector" onchange="switchPlaylist()" style="padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);color:#fff"></select>
      </div>

      <div style="display:flex;gap:8px;">
        <button class="btn btn-primary" onclick="createPlaylistWithPopup()">New</button>

        <button class="btn btn-warning" onclick="renamePlaylistWithPopup()">Rename</button>


        

        <button class="btn btn-danger" onclick="deletePlaylistWithPopup()">Delete</button>
        <button class="btn btn-success" onclick="exportCurrentPlaylist()">Export</button>
      </div>
    </div>

    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px;flex-wrap:wrap;">
      <div style="display:flex;gap:8px;align-items:center;">
        <label for="similaritySelect" class="small" style="opacity:0.8">Similarity</label>
        <select id="similaritySelect" style="padding:6px 8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.1);color:#fff">
          <option value="euclidean" selected>Euclidean</option>
          <option value="cosine">Cosine</option>
          <option value="weighted_cosine">Weighted Cosine</option>
        </select>
        <label for="normalizeToggle" class="small" style="margin-left:12px;opacity:0.8">Normalize</label>
        <input type="checkbox" id="normalizeToggle" />
      </div>
      <div style="display:flex;gap:12px;align-items:center;">
        <button class="btn btn-warning" onclick="optimizePlaylist()">Optimize Flow</button>
        <button class="btn btn-primary" onclick="getRecommendations()">Get Recommendations</button>
        <button class="btn btn-danger" onclick="clearPlaylistWithPopup()">Clear All</button>
      </div>
    </div>

    <h3 style="margin-bottom:8px"><span id="currentPlaylistName">My Playlist</span> (<span id="playlistCount">0</span>)</h3>

    <div id="playlist" style="margin-top:12px"></div>
  </div>

  <div style="height:16px"></div>

  <div class="container-card" id="recommendationsSection">
    <h2>Recommendations</h2>
    <p class="small" style="color:rgba(255,255,255,0.6)">Based on your playlist</p>
    <div id="recommendations" style="margin-top:12px"></div>
  </div>
{% endblock %}

{% block body_extra %}
<!-- ‚úÖ Confirm Modal -->
<div id="confirmModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:1000;justify-content:center;align-items:center;">
  <div style="background:#1b1b2f;padding:26px 30px;border-radius:14px;max-width:400px;width:90%;text-align:center;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.4);">
    <h3 id="confirmTitle" style="margin-bottom:12px;font-weight:700;color:#fff;">Confirm</h3>
    <p id="confirmMessage" style="margin-bottom:22px;color:rgba(255,255,255,0.7)">Are you sure?</p>
    <div style="display:flex;gap:12px;justify-content:center;">
      <button id="confirmCancel" class="btn btn-secondary">Cancel</button>
      <button id="confirmOk" class="btn btn-danger">OK</button>
    </div>
  </div>
</div>

<!-- ‚úÖ Input Modal (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö New / Rename) -->
<div id="inputModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.55);z-index:1001;justify-content:center;align-items:center;">
  <div style="background:#1b1b2f;padding:26px 30px;border-radius:14px;max-width:400px;width:90%;text-align:center;color:#fff;box-shadow:0 10px 30px rgba(0,0,0,0.4);">
    <h3 id="inputTitle" style="margin-bottom:12px;font-weight:700;color:#fff;">Enter Name</h3>
    <input id="inputField" type="text" placeholder="Enter name..." style="width:90%;padding:10px 14px;border-radius:8px;border:none;background:rgba(255,255,255,0.1);color:#fff;margin-bottom:22px;">
    <div style="display:flex;gap:12px;justify-content:center;">
      <button id="inputCancel" class="btn btn-secondary">Cancel</button>
      <button id="inputOk" class="btn btn-primary">OK</button>
    </div>
  </div>
</div>


<script>
  // ‚úÖ Toast Notification
  function showToast(message, type='success'){
    const toast=document.createElement('div');
    toast.className='message-toast';
    toast.textContent=message;
    toast.style.background=type==='error'
      ? 'linear-gradient(90deg,#e74c3c,#ff7675)'
      : 'linear-gradient(90deg,#28a745,#3ddc84)';
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(),3500);
  }

  // ‚úÖ Confirm Modal
  function customConfirm(title, message){
    return new Promise((resolve)=>{
      const modal=document.getElementById('confirmModal');
      document.getElementById('confirmTitle').textContent=title;
      document.getElementById('confirmMessage').textContent=message;
      modal.style.display='flex';

      const cancel=document.getElementById('confirmCancel');
      const ok=document.getElementById('confirmOk');

      const cleanup=()=>{
        modal.style.display='none';
        cancel.replaceWith(cancel.cloneNode(true));
        ok.replaceWith(ok.cloneNode(true));
      };

      document.getElementById('confirmCancel').onclick=()=>{cleanup();resolve(false);};
      document.getElementById('confirmOk').onclick=()=>{cleanup();resolve(true);};
    });
  }
  // ‚úÖ Custom Input Modal (‡πÉ‡∏ä‡πâ‡πÅ‡∏ó‡∏ô prompt)
function customPrompt(title, placeholder="") {
  return new Promise((resolve) => {
    const modal = document.getElementById('inputModal');
    const titleEl = document.getElementById('inputTitle');
    const inputEl = document.getElementById('inputField');
    titleEl.textContent = title;
    inputEl.value = "";
    inputEl.placeholder = placeholder;
    modal.style.display = 'flex';
    inputEl.focus();

    const cancel = document.getElementById('inputCancel');
    const ok = document.getElementById('inputOk');

    const cleanup = () => {
      modal.style.display = 'none';
      cancel.replaceWith(cancel.cloneNode(true));
      ok.replaceWith(ok.cloneNode(true));
    };

    document.getElementById('inputCancel').onclick = () => { cleanup(); resolve(null); };
    document.getElementById('inputOk').onclick = () => {
      const val = inputEl.value.trim();
      cleanup();
      resolve(val || null);
    };
  });
}

  // ‚úÖ Clear All
  async function clearPlaylistWithPopup(){
    const confirmed = await customConfirm('Clear Playlist', 'Are you sure you want to clear all songs?');
    if(!confirmed) return;
    const r=await fetch('/api/playlist/clear',{method:'POST'});
    const j=await r.json();
    if(j.success){
      showToast('üóë Playlist cleared!');
      loadPlaylist();
    } else {
      showToast(j.error||'Failed to clear','error');
    }
  }

  // ‚úÖ Delete Playlist
  async function deletePlaylistWithPopup(){
    const sel=document.getElementById('playlistSelector');
    if(!sel) return;
    const playlistName=sel.value;
    const confirmed = await customConfirm('Delete Playlist', `Delete "${playlistName}" permanently?`);
    if(!confirmed) return;
    const res=await fetch('/api/playlists/delete',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({name:playlistName})
    });
    const j=await res.json();
    if(j.success){
      showToast(`üóë Deleted "${playlistName}"`);
      loadAllPlaylists();
      loadPlaylist();
    }else{
      showToast(j.error||'Delete failed','error');
    }
  }
// ‚úÖ New Playlist popup
async function createPlaylistWithPopup() {
  const name = await customPrompt('New Playlist', 'Enter playlist name');
  if (!name) return;
  const res = await fetch('/api/playlists/create', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ name })
  });
  const j = await res.json();
  if (j.success) {
    showToast('üéµ Playlist created!');
    loadAllPlaylists();
    loadPlaylist();
  } else {
    showToast(j.error || 'Failed to create playlist', 'error');
  }
}

// ‚úÖ Rename Playlist popup
async function renamePlaylistWithPopup() {
  const sel = document.getElementById('playlistSelector');
  if (!sel) return;
  const oldName = sel.value;
  const newName = await customPrompt('Rename Playlist', oldName);
  if (!newName || newName === oldName) return;
  const res = await fetch('/api/playlists/rename', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ old_name: oldName, new_name: newName })
  });
  const j = await res.json();
  if (j.success) {
    showToast('‚úèÔ∏è Playlist renamed!');
    loadAllPlaylists();
  } else {
    showToast(j.error || 'Rename failed', 'error');
  }
}

  // ‚úÖ Optimize Flow
  async function optimizePlaylist() {
    const sim = document.getElementById('similaritySelect').value;
    const normalize = document.getElementById('normalizeToggle').checked;
    try {
      const res = await fetch('/api/playlist/optimize', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ similarity: sim, normalize })
      });
      const data = await res.json();
      if (data.success) {
        showToast('Playlist optimized successfully!');
        loadPlaylist();
      } else {
        showToast(data.error || 'Optimization failed', 'error');
      }
    } catch (err) {
      showToast('Error optimizing playlist', 'error');
    }
  }

//   
//   async function getRecommendations() {
//     try {
//       const res = await fetch('/api/recommendations', { method:'POST' });
//       const data = await res.json();
//       if (data.success) {
//         showToast('üé∂ Recommendations ready!');
//         if (data.html) document.getElementById('recommendations').innerHTML = data.html;
//       } else {
//         showToast(data.error || 'Failed to get recommendations', 'error');
//       }
//     } catch {
//       showToast('Error getting recommendations', 'error');
//     }
//   }
// </script>

<style>
  .message-toast{
    position:fixed;
    top:22px;
    right:22px;
    background:linear-gradient(90deg,#28a745,#3ddc84);
    color:#fff;
    padding:14px 20px;
    border-radius:10px;
    font-weight:600;
    z-index:9999;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
    animation:fadeInOut 3.5s ease forwards;
  }
  @keyframes fadeInOut{
    0%{opacity:0;transform:translateY(-10px);}
    10%,90%{opacity:1;transform:translateY(0);}
    100%{opacity:0;transform:translateY(-10px);}
  }
</style>
{% endblock %}
